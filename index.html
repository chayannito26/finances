<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Manager</title>
    <meta name="description" content="Manage your finances with Chayannito 26 Finance Dashboard. Track income, expenses, and receipts easily.">
    <!-- Open Graph -->
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="View current rag day fund status with a history of expenses and revenue.">
    <meta property="og:title" content="Chayannito 26 Finance Dashboard">
    <meta property="og:description" content="View current rag day fund status with a history of expenses and revenue.">
    <meta property="og:image" content="https://chayannito26.com/finances/image.jpg">
    <meta property="og:url" content="https://chayannito26.com/finances">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Chayannito 26 Finance Dashboard">
    <meta property="og:brand" content="Chayannito 26">

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Chayannito 26 Finance Dashboard">
    <meta name="twitter:description" content="View current rag day fund status with a history of expenses and revenue.">
    <meta name="twitter:image" content="https://chayannito26.com/finances/image.jpg">
    <meta name="twitter:site" content="@chayannito26">
    <meta name="twitter:creator" content="@wasi_master">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.25s ease; }
        .modal-active { overflow: hidden; }
        .modal-content { transition: transform 0.25s ease; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-scroll { flex: 1 1 auto; overflow-y: auto; }
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #555; }
        /* Hide number input spinners */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            appearance: textfield;
            -webkit-appearance: textfield;
            -moz-appearance: textfield;
        }
        /* Keep receipts area from growing too tall */
        #receipts-list { max-height: 12rem; overflow-y: auto; }
        /* Lightbox */
        #image-lightbox { background: rgba(0,0,0,0.8); }
        #image-lightbox img { max-width: 90vw; max-height: 90vh; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        /* Preset buttons (plain CSS; @apply doesn't work via CDN) */
        .preset-btn {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db; /* gray-300 */
            font-size: 0.875rem; /* text-sm */
            background: #fff;
            color: #374151; /* gray-700 */
            cursor: pointer;
        }
        .preset-btn:hover { background: #f9fafb; } /* gray-50 */
        .preset-active {
            background: #4f46e5; /* indigo-600 */
            color: #fff;
            border-color: #4f46e5;
        }
        .preset-inactive { background: #fff; color: #374151; border-color: #d1d5db; }
        /* Push toolbar centered below the header */
        .push-toolbar {
            position: relative;
            z-index: 20;
            background: transparent;
        }
        .push-toolbar-inner { max-width: 1100px; margin: 0 auto; padding: 0.5rem 1rem; display:flex; justify-content:center; }
        @media (min-width: 1024px) {
            .push-toolbar-inner { padding: 0.75rem 1.5rem; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Finance Dashboard</h1>
            <p class="text-gray-600 mt-2">Your data is now saved automatically.</p>
        </header>

        <!-- Centered push toolbar placed directly below the header -->
        <div class="push-toolbar mb-4">
            <div class="push-toolbar-inner">
                <button id="push-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg inline-flex items-center gap-2 disabled:opacity-60">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span id="push-btn-label">Push to GitHub</span>
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div id="header-flex-container" class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                <!-- Left side: Cash at Hand -->
                <div id="cash-at-hand-container" class="text-center lg:text-left">
                    <h2 class="text-lg font-semibold text-gray-500 mb-2">Cash at Hand</h2>
                    <p id="cash-at-hand" class="text-4xl font-bold text-indigo-600">৳0</p>
                </div>

                <!-- Vertical separator (hidden on mobile) -->
                <div id="cash-separator" class="hidden lg:block w-px h-16 bg-gray-200"></div>

                <!-- Right side: Editable Cash Fields -->
                <div id="cash-fields-container" class="grid grid-cols-1 sm:grid-cols-3 gap-4 min-w-0 lg:min-w-max">
                    <div>
                        <label for="cash-field" class="block text-sm font-medium text-gray-700 mb-1">Cash</label>
                        <input type="number" step="any" id="cash-field" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-center" placeholder="0" value="0">
                    </div>
                    <div>
                        <label for="bkash-field" class="block text-sm font-medium text-gray-700 mb-1">bKash</label>
                        <input type="number" step="any" id="bkash-field" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-center" placeholder="0" value="0">
                    </div>
                    <div>
                        <label for="bank-field" class="block text-sm font-medium text-gray-700 mb-1">Bank</label>
                        <input type="number" step="any" id="bank-field" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-center" placeholder="0" value="0">
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Income Section -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Income</h2>
                    <button onclick="openModal('incomeModal', true)" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-transform transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i> Add Income
                    </button>
                </div>
                <div class="overflow-x-auto table-container">
                    <table class="w-full text-left min-w-[600px]">
                        <thead>
                            <tr class="bg-gray-50 border-b">
                                <th class="p-4 font-semibold">Source</th>
                                <th class="p-4 font-semibold">Amount</th>
                                <th class="p-4 font-semibold">Date</th>
                                <th class="p-4 font-semibold">Clients</th>
                                <th class="p-4 font-semibold text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="income-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- Expenses Section -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Expenses</h2>
                    <button onclick="openModal('expenseModal', true)" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center transition-transform transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i> Add Expense
                    </button>
                </div>
                <div class="overflow-x-auto table-container">
                    <table class="w-full text-left min-w-[600px]">
                        <thead>
                            <tr class="bg-gray-50 border-b">
                                <th class="p-4 font-semibold">Purpose</th>
                                <th class="p-4 font-semibold">Amount</th>
                                <th class="p-4 font-semibold">Date</th>
                                <th class="p-4 font-semibold">Receipts</th>
                                <th class="p-4 font-semibold text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expense-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer kept for other content; push button moved to top toolbar -->
    <footer class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="text-center text-xs text-gray-500">&copy; Chayannito 26</div>
    </footer>

    <!-- Modals -->
    <div id="incomeModal" class="modal-wrapper fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold" id="income-modal-title">Add Income</h3>
                <button onclick="closeModal('incomeModal')" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="income-form">
                <input type="hidden" id="income-id">
                <div class="mb-4"><label for="income-source" class="block text-sm font-medium text-gray-700 mb-1">Source</label><input type="text" id="income-source" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></div>
                <div class="mb-4"><label for="income-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label><input type="number" step="any" id="income-amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></div>
                <div class="mb-4"><label for="income-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label><input type="date" id="income-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></div>
                <div class="mb-4"><label for="income-type" class="block text-sm font-medium text-gray-700 mb-1">Type</label><input type="text" id="income-type" list="income-types-datalist" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required><datalist id="income-types-datalist"></datalist></div>
                <div class="mb-4"><label for="income-clients" class="block text-sm font-medium text-gray-700 mb-1">Clients (comma separated)</label><input type="text" id="income-clients" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                <div class="mb-4"><label for="income-comments" class="block text-sm font-medium text-gray-700 mb-1">Comments</label><textarea id="income-comments" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea></div>
                <div class="flex justify-end"><button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg">Save</button></div>
            </form>
        </div>
    </div>

    <div id="expenseModal" class="modal-wrapper fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold" id="expense-modal-title">Add Expense</h3>
                <button onclick="closeModal('expenseModal')" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>

            <!-- Make form scrollable, keep actions visible -->
            <form id="expense-form" class="flex flex-col overflow-hidden">
                <input type="hidden" id="expense-id">
                <div class="modal-scroll space-y-4 pr-1">
                    <div class="mb-4"><label for="expense-purpose" class="block text-sm font-medium text-gray-700 mb-1">Purpose</label><input type="text" id="expense-purpose" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></div>
                    <div class="mb-4"><label for="expense-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label><input type="number" step="any" id="expense-amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></div>
                    <div class="mb-4"><label for="expense-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label><input type="date" id="expense-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></div>
                    <div class="mb-4"><label for="expense-type" class="block text-sm font-medium text-gray-700 mb-1">Type</label><input type="text" id="expense-type" list="expense-types-datalist" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required><datalist id="expense-types-datalist"></datalist></div>
                    <div class="mb-4"><label for="expense-persons" class="block text-sm font-medium text-gray-700 mb-1">Persons (comma separated)</label><input type="text" id="expense-persons" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
                    <div class="mb-4"><label for="expense-comments" class="block text-sm font-medium text-gray-700 mb-1">Comments</label><textarea id="expense-comments" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea></div>

                    <!-- Receipt Management Section -->
                    <div class="border-t pt-4 mt-4">
                        <h4 class="text-lg font-semibold mb-2">Receipts</h4>
                        <div id="receipts-list" class="mb-2 space-y-2"></div>

                        <!-- Inputs: file + filename + description -->
                        <input type="file" id="receipt-file-input" class="hidden" accept=".png,.jpg,.jpeg,.webp,.gif,.pdf,image/*,application/pdf">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                            <div class="sm:col-span-1">
                                <input
                                    type="text"
                                    id="receipt-filename-input"
                                    placeholder="File name (no ext)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                    aria-label="Receipt file name"
                                >
                            </div>
                            <div class="sm:col-span-2">
                                <input
                                    type="text"
                                    id="receipt-description-input"
                                    placeholder="Description"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                    aria-label="Receipt description"
                                >
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                            <button
                                type="button"
                                id="receipt-browse-btn"
                                onclick="document.getElementById('receipt-file-input').click()"
                                class="bg-blue-500 hover:bg-blue-600 text-white font-bold p-2 rounded-lg disabled:opacity-50"
                                title="Choose a file"
                            >
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <span id="receipt-selected-name" class="text-sm text-gray-600 truncate"></span>
                            <button
                                type="button"
                                id="receipt-upload-btn"
                                class="bg-green-600 hover:bg-green-700 text-white font-bold px-3 py-2 rounded-lg disabled:opacity-50"
                                title="Upload receipt"
                                disabled
                            >
                                Upload
                            </button>
                        </div>

                        <!-- Compression controls (shown for images except GIF) -->
                        <div id="compress-controls" class="mt-3 hidden">
                            <div class="text-sm text-gray-700 font-medium mb-2">Image compression</div>
                            <div class="flex flex-wrap items-center gap-2 mb-2">
                                <span class="text-xs text-gray-500">Resolution:</span>
                                <!-- Added 100% option -->
                                <button type="button" class="preset-btn preset-inactive" data-percent="100">100%</button>
                                <button type="button" class="preset-btn preset-inactive" data-percent="75">75%</button>
                                <button type="button" class="preset-btn preset-inactive" data-percent="50">50%</button>
                                <button type="button" class="preset-btn preset-inactive" data-percent="33">33%</button>
                                <button type="button" class="preset-btn preset-inactive" data-percent="25">25%</button>
                                <button type="button" class="preset-btn preset-inactive" data-percent="15">15%</button>
                                <span id="compress-res-label" class="ml-auto text-xs text-gray-600"></span>
                            </div>
                            <div class="flex items-center gap-3">
                                <label class="text-xs text-gray-500">JPEG quality</label>
                                <!-- Max increased to 100, default stays 80 -->
                                <input type="range" id="compress-quality" min="40" max="100" step="1" value="80" class="w-40">
                                <span id="compress-quality-label" class="text-xs text-gray-600">80</span>
                                <span id="compress-size-label" class="ml-auto text-xs text-gray-600"></span>
                            </div>
                            <div id="compress-note" class="text-xs text-gray-500 mt-1"></div>
                            <!-- Decision UI appears when compressed >= original -->
                            <div id="compress-decision" class="mt-2 text-sm hidden">
                                <!-- populated by JS -->
                            </div>
                        </div>

                        <div class="text-xs text-gray-500 mt-2">
                            Images or PDF only. Both filename and description are required.
                            PDFs are saved as-is. Animated GIFs are uploaded without compression.
                        </div>
                        <div id="upload-status" class="text-sm text-gray-500 mt-1"></div>
                    </div>
                </div>

                <!-- Sticky actions -->
                <div class="flex justify-end mt-4 pt-3 border-t bg-white">
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lightbox for image previews -->
    <div id="image-lightbox" class="fixed inset-0 hidden items-center justify-center z-50">
        <div class="absolute inset-0" onclick="closeLightbox()"></div>
        <div class="relative flex items-center justify-center p-4">
            <img id="lightbox-img" src="" alt="">
            <button class="absolute top-2 right-2 text-white text-3xl leading-none" onclick="closeLightbox()" aria-label="Close">&times;</button>
        </div>
    </div>

    <!-- Receipt Edit Modal -->
    <div id="receiptEditModal" class="modal-wrapper fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Edit Receipt</h3>
                <button onclick="closeReceiptEditModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="edit-receipt-form" class="flex flex-col overflow-hidden">
                <input type="hidden" id="edit-receipt-index">
                <div class="modal-scroll space-y-3 pr-1">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">File name (no ext)</label>
                        <input type="text" id="edit-receipt-filename-input" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="e.g. invoice_123">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <input type="text" id="edit-receipt-description-input" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Description">
                    </div>

                    <div class="border-t pt-3">
                        <h4 class="text-md font-semibold mb-2">Replace File (optional)</h4>
                        <input type="file" id="edit-receipt-file-input" class="hidden" accept=".png,.jpg,.jpeg,.webp,.gif,.pdf,image/*,application/pdf">
                        <div class="flex items-center gap-2">
                            <button type="button" id="edit-receipt-browse-btn" onclick="document.getElementById('edit-receipt-file-input').click()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold p-2 rounded-lg">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <span id="edit-receipt-selected-name" class="text-sm text-gray-600 truncate"></span>
                            <button type="button" id="edit-receipt-clear-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold px-3 py-2 rounded-lg hidden">Clear</button>
                        </div>

                        <div id="edit-compress-controls" class="mt-3 hidden">
                            <div class="text-sm text-gray-700 font-medium mb-2">Image compression</div>
                            <div class="flex flex-wrap items-center gap-2 mb-2">
                                <span class="text-xs text-gray-500">Resolution:</span>
                                <button type="button" class="preset-btn preset-inactive" data-percent="100">100%</button>
                                <button type="button" class="preset-btn preset-inactive" data-percent="75">75%</button>
                                <button type="button" class="preset-btn preset-inactive" data-percent="50">50%</button>
                                <button type="button" class="preset-btn preset-inactive" data-percent="33">33%</button>
                                <button type="button" class="preset-btn preset-inactive" data-percent="25">25%</button>
                                <button type="button" class="preset-btn preset-inactive" data-percent="15">15%</button>
                                <span id="edit-compress-res-label" class="ml-auto text-xs text-gray-600"></span>
                            </div>
                            <div class="flex items-center gap-3">
                                <label class="text-xs text-gray-500">JPEG quality</label>
                                <input type="range" id="edit-compress-quality" min="40" max="100" step="1" value="80" class="w-40">
                                <span id="edit-compress-quality-label" class="text-xs text-gray-600">80</span>
                                <span id="edit-compress-size-label" class="ml-auto text-xs text-gray-600"></span>
                            </div>
                            <div id="edit-compress-note" class="text-xs text-gray-500 mt-1"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">
                            If you keep the same name, the file will be overwritten. Images are converted to JPEG when compression is enabled.
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-4 pt-3 border-t bg-white">
                    <button type="button" onclick="closeReceiptEditModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" id="edit-receipt-save-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Push result modal -->
    <div id="pushModal" class="modal-wrapper fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-2xl p-6 rounded-xl shadow-2xl transform scale-95">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-2xl font-bold">Push Result</h3>
                <button onclick="closePushModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="push-summary" class="text-sm text-gray-700 mb-3"></div>
            <pre id="push-log" class="text-xs bg-gray-100 p-3 rounded overflow-auto max-h-80"></pre>
            <div class="flex justify-end mt-4">
                <button onclick="closePushModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA MANAGEMENT ---
        let revenues = [];
        let expenses = [];
        let tempReceipts = []; // To hold receipts before saving an expense
        let isServerMode = false; // server vs GitHub fallback

        // Compression / upload state
        const ALLOWED_RECEIPT_TYPES = ['image/png', 'image/jpeg', 'image/webp', 'image/gif', 'application/pdf'];
        const MAX_RECEIPT_SIZE_BYTES = 10 * 1024 * 1024; // 10 MB
        let currentChosenFile = null;
        let compression = {
            enabled: false,
            original: { width: 0, height: 0, size: 0, type: '' },
            percent: 100, // default to 100%
            quality: 0.8,
            blob: null,
            blobSize: 0,
            outputExt: '.jpg'
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();
            document.getElementById('receipt-file-input').addEventListener('change', onReceiptFileChosen);
            document.getElementById('receipt-upload-btn').addEventListener('click', handleReceiptUpload);
            // Compression control listeners
            setupCompressionControls();
            loadCashFields();
            setupCashFieldListeners();
            const pushBtn = document.getElementById('push-btn');
            if (pushBtn) pushBtn.addEventListener('click', pushToGitHub);
        });

        // --- Modal helpers to reset receipt inputs ---
        function resetReceiptInputs() {
            const fileInput = document.getElementById('receipt-file-input');
            const filenameInput = document.getElementById('receipt-filename-input');
            const descriptionInput = document.getElementById('receipt-description-input');
            const nameSpan = document.getElementById('receipt-selected-name');
            const statusDiv = document.getElementById('upload-status');
            currentChosenFile = null;
            compression.enabled = false;
            compression.blob = null;
            compression.blobSize = 0;
            compression.original = { width: 0, height: 0, size: 0, type: '' };
            compression.percent = 100; // default to 100%
            compression.quality = 0.8;
            fileInput.value = '';
            filenameInput.value = '';
            descriptionInput.value = '';
            nameSpan.textContent = '';
            statusDiv.textContent = '';
            document.getElementById('compress-controls').classList.add('hidden');
            updateUploadButtonState();
        }

        // --- CASH FIELDS MANAGEMENT ---
        function loadCashFields() {
            // Load values from localStorage or default to 0
            document.getElementById('cash-field').value = localStorage.getItem('finance_cash') || '0';
            document.getElementById('bkash-field').value = localStorage.getItem('finance_bkash') || '0';
            document.getElementById('bank-field').value = localStorage.getItem('finance_bank') || '0';
        }

        function setupCashFieldListeners() {
            // Add event listeners to save values to localStorage when they change
            document.getElementById('cash-field').addEventListener('input', function(e) {
                localStorage.setItem('finance_cash', e.target.value || '0');
            });

            document.getElementById('bkash-field').addEventListener('input', function(e) {
                localStorage.setItem('finance_bkash', e.target.value || '0');
            });

            document.getElementById('bank-field').addEventListener('input', function(e) {
                localStorage.setItem('finance_bank', e.target.value || '0');
            });
        }

        async function loadInitialData() {
            try {
                const response = await fetch('/api/data');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                revenues = data.revenues || [];
                expenses = data.expenses || [];
                isServerMode = true;
                // Show push button in server mode
                document.getElementById('push-btn')?.classList.remove('hidden');
                render();
            } catch (error) {
                console.error('Failed to load data from server:', error);
                alert('Could not connect to the server. Reading from fallback data.');

                // UI changes for fallback mode
                document.getElementById('cash-fields-container').style.display = 'none';
                document.getElementById('cash-separator').style.display = 'none';
                const headerFlexContainer = document.getElementById('header-flex-container');
                headerFlexContainer.classList.remove('lg:justify-between');
                headerFlexContainer.classList.add('lg:justify-center');
                const cashAtHandContainer = document.getElementById('cash-at-hand-container');
                cashAtHandContainer.classList.remove('lg:text-left');
                cashAtHandContainer.classList.add('lg:text-center');

                // Hide push button in fallback mode
                document.getElementById('push-btn')?.classList.add('hidden');

                try {
                    const [revenuesResponse, expensesResponse] = await Promise.all([
                        fetch('https://raw.githubusercontent.com/chayannito26/income/refs/heads/main/revenues.json'),
                        fetch('https://raw.githubusercontent.com/chayannito26/expenses/refs/heads/main/expenses.json')
                    ]);

                    if (!revenuesResponse.ok || !expensesResponse.ok) {
                        throw new Error('Failed to load one or more fallback files.');
                    }

                    revenues = await revenuesResponse.json() || [];
                    expenses = await expensesResponse.json() || [];
                    isServerMode = false;
                    render();
                } catch (fallbackError) {
                    console.error('Failed to load fallback data:', fallbackError);
                    alert('Could not load fallback data either. Please check your internet connection and the console for errors.');
                }
            }
        }

        // --- RENDERING LOGIC ---
        function render() {
            renderIncomeTable();
            renderExpenseTable();
            calculateCashAtHand();
            updateTypeDatalists();
        }

        function formatCurrency(amount) {
            const numAmount = parseFloat(amount);
            const formattedAmount = Number.isInteger(numAmount) ? numAmount : numAmount.toFixed(2);
            return `৳${formattedAmount}`;
        }

        function renderIncomeTable() {
            const tableBody = document.getElementById('income-table');
            tableBody.innerHTML = revenues.map(item => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4">${item.source || ''}</td>
                    <td class="p-4 text-green-600 font-medium">${formatCurrency(item.amount || 0)}</td>
                    <td class="p-4">${item.date || ''}</td>
                    <td class="p-4">${(item.clients || []).join(', ')}</td>
                    <td class="p-4 text-right whitespace-nowrap">
                        <button onclick="editIncome(${item.id})" class="text-indigo-600 hover:text-indigo-900 mr-3"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteIncome(${item.id})" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        }

        function renderExpenseTable() {
            const tableBody = document.getElementById('expense-table');
            tableBody.innerHTML = expenses.map(item => {
                const receiptsHtml = (item.receipts && Array.isArray(item.receipts) && item.receipts.length > 0)
                    ? item.receipts.map(r => {
                        let url = r.url || '';
                        if (!url) return '';
                        if (!isServerMode && /^\.\/receipts\//.test(url)) {
                            // Map to GitHub raw; strip query to get actual filename
                            const fname = stripQuery(url).split('/').pop();
                            url = `https://raw.githubusercontent.com/chayannito26/expenses/refs/heads/main/receipts/${fname}`;
                        }
                        const desc = r.description || (r.filename || 'Receipt');
                        return `<a href="${url}" target="_blank" class="text-blue-500 hover:underline">${desc}</a>`;
                      }).join('<br>')
                    : 'None';
                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4">${item.purpose || ''}</td>
                    <td class="p-4 text-red-600 font-medium">${formatCurrency(item.amount || 0)}</td>
                    <td class="p-4">${item.date || ''}</td>
                    <td class="p-4">${receiptsHtml}</td>
                    <td class="p-4 text-right whitespace-nowrap">
                        <button onclick="editExpense(${item.id})" class="text-indigo-600 hover:text-indigo-900 mr-3"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteExpense(${item.id})" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`}).join('');
        }

        function calculateCashAtHand() {
            const totalIncome = revenues.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            const totalExpenses = expenses.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            document.getElementById('cash-at-hand').textContent = formatCurrency(totalIncome - totalExpenses);
        }

        function updateTypeDatalists() {
            const incomeTypes = [...new Set(revenues.map(i => i.type))];
            const expenseTypes = [...new Set(expenses.map(e => e.type))];
            document.getElementById('income-types-datalist').innerHTML = incomeTypes.map(type => `<option value="${type}"></option>`).join('');
            document.getElementById('expense-types-datalist').innerHTML = expenseTypes.map(type => `<option value="${type}"></option>`).join('');
        }

        // --- MODAL HANDLING ---
        function openModal(modalId, isNew = false) {
            if (isNew) {
                const today = new Date().toISOString().split('T')[0];
                if (modalId === 'incomeModal') {
                    document.getElementById('income-form').reset();
                    document.getElementById('income-id').value = '';
                    document.getElementById('income-modal-title').innerText = 'Add Income';
                    document.getElementById('income-date').value = today;
                } else {
                    document.getElementById('expense-form').reset();
                    document.getElementById('expense-id').value = '';
                    document.getElementById('expense-modal-title').innerText = 'Add Expense';
                    document.getElementById('expense-date').value = today;
                    tempReceipts = [];
                    renderTempReceipts();
                    resetReceiptInputs(); // ensure clean receipt inputs
                }
            }
            document.getElementById(modalId).classList.remove('hidden');
            document.body.classList.add('modal-active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.body.classList.remove('modal-active');
            if (modalId === 'expenseModal') {
                resetReceiptInputs(); // also clear on close
            }
        }

        // --- CRUD OPERATIONS via API ---
        document.getElementById('income-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('income-id').value;
            const incomeData = {
                id: id ? parseInt(id) : null,
                source: document.getElementById('income-source').value,
                amount: parseFloat(document.getElementById('income-amount').value),
                date: document.getElementById('income-date').value,
                type: document.getElementById('income-type').value,
                clients: document.getElementById('income-clients').value.split(',').map(s => s.trim()).filter(Boolean),
                comments: document.getElementById('income-comments').value
            };

            await fetch('/api/income', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(incomeData)
            });

            closeModal('incomeModal');
            loadInitialData(); // Reload all data from server
        });

        document.getElementById('expense-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = document.getElementById('expense-id').value;
            const expenseData = {
                id: id ? parseInt(id) : null,
                purpose: document.getElementById('expense-purpose').value,
                amount: parseFloat(document.getElementById('expense-amount').value),
                date: document.getElementById('expense-date').value,
                type: document.getElementById('expense-type').value,
                persons: document.getElementById('expense-persons').value.split(',').map(s => s.trim()).filter(Boolean),
                comments: document.getElementById('expense-comments').value,
                receipts: tempReceipts
            };

            await fetch('/api/expenses', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(expenseData)
            });

            closeModal('expenseModal');
            loadInitialData();
        });

        function editIncome(id) {
            const income = revenues.find(item => item.id === id);
            if (income) {
                document.getElementById('income-modal-title').innerText = 'Edit Income';
                document.getElementById('income-id').value = income.id;
                document.getElementById('income-source').value = income.source;
                document.getElementById('income-amount').value = income.amount;
                document.getElementById('income-date').value = income.date;
                document.getElementById('income-type').value = income.type;
                document.getElementById('income-clients').value = (income.clients || []).join(', ');
                document.getElementById('income-comments').value = income.comments;
                openModal('incomeModal');
            }
        }

        async function deleteIncome(id) {
            if (confirm('Are you sure you want to delete this income entry?')) {
                await fetch(`/api/income/${id}`, { method: 'DELETE' });
                loadInitialData();
            }
        }

        function editExpense(id) {
            const expense = expenses.find(item => item.id === id);
            if (expense) {
                document.getElementById('expense-modal-title').innerText = 'Edit Expense';
                document.getElementById('expense-id').value = expense.id;
                document.getElementById('expense-purpose').value = expense.purpose;
                document.getElementById('expense-amount').value = expense.amount;
                document.getElementById('expense-date').value = expense.date;
                document.getElementById('expense-type').value = expense.type;
                document.getElementById('expense-persons').value = (expense.persons || []).join(', ');
                document.getElementById('expense-comments').value = expense.comments;
                tempReceipts = (expense.receipts && Array.isArray(expense.receipts)) ? [...expense.receipts] : [];
                renderTempReceipts();
                resetReceiptInputs();
                openModal('expenseModal');
            }
        }

        async function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense entry?')) {
                await fetch(`/api/expenses/${id}`, { method: 'DELETE' });
                loadInitialData();
            }
        }

        // --- RECEIPT MANAGEMENT + Compression ---
        function titleCase(str) {
            return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
        }
        function formatBytes(bytes) {
            if (!bytes && bytes !== 0) return '';
            const units = ['B','KB','MB','GB'];
            let i = 0, num = bytes;
            while (num >= 1024 && i < units.length - 1) { num /= 1024; i++; }
            return `${num.toFixed(num < 10 && i > 0 ? 1 : 0)} ${units[i]}`;
        }

        function updateUploadButtonState() {
            const hasFile = !!(currentChosenFile);
            const hasName = (document.getElementById('receipt-filename-input').value || '').trim().length > 0;
            const hasDesc = (document.getElementById('receipt-description-input').value || '').trim().length > 0;
            document.getElementById('receipt-upload-btn').disabled = !(hasFile && hasName && hasDesc);
        }

        function setupCompressionControls() {
            const presets = Array.from(document.querySelectorAll('#compress-controls .preset-btn'));
            const qInput = document.getElementById('compress-quality');

            presets.forEach(btn => {
                btn.addEventListener('click', () => {
                    presets.forEach(b => b.classList.remove('preset-active'));
                    presets.forEach(b => b.classList.add('preset-inactive'));
                    btn.classList.add('preset-active');
                    btn.classList.remove('preset-inactive');
                    compression.percent = parseInt(btn.dataset.percent, 10);
                    updateCompressionLabels();
                    if (compression.enabled) computeCompressedBlob();
                });
            });

            qInput.addEventListener('input', () => {
                const q = Math.max(40, Math.min(100, parseInt(qInput.value, 10) || 80)); // allow up to 100
                compression.quality = q / 100;
                document.getElementById('compress-quality-label').textContent = String(q);
                if (compression.enabled) computeCompressedBlob();
            });

            // Initialize default active preset to 100%
            const defaultPreset = document.querySelector('#compress-controls .preset-btn[data-percent="100"]');
            if (defaultPreset) {
                defaultPreset.classList.add('preset-active');
                defaultPreset.classList.remove('preset-inactive');
            }
        }

        function onReceiptFileChosen(e) {
            const file = e.target.files && e.target.files[0] ? e.target.files[0] : null;
            const nameSpan = document.getElementById('receipt-selected-name');
            const filenameInput = document.getElementById('receipt-filename-input');
            const descriptionInput = document.getElementById('receipt-description-input');

            currentChosenFile = null;
            nameSpan.textContent = '';
            compression.enabled = false;
            compression.blob = null;
            compression.blobSize = 0;
            document.getElementById('compress-controls').classList.add('hidden');
            document.getElementById('compress-note').textContent = '';

            if (!file) { updateUploadButtonState(); return; }

            if (!ALLOWED_RECEIPT_TYPES.includes(file.type)) {
                alert('Unsupported file type. Please select an image or PDF.');
                e.target.value = '';
                updateUploadButtonState();
                return;
            }
            if (file.size > MAX_RECEIPT_SIZE_BYTES) {
                alert('File too large. Max 10 MB.');
                e.target.value = '';
                updateUploadButtonState();
                return;
            }

            currentChosenFile = file;
            nameSpan.textContent = file.name;

            // Autofill defaults from uploaded filename if empty
            const base = file.name.replace(/\.[^/.]+$/, '');
            const safeBase = base.replace(/[^\w\-]+/g, '_');
            if (!filenameInput.value.trim()) filenameInput.value = safeBase;
            if (!descriptionInput.value.trim()) {
                const human = titleCase(base.replace(/[-_]+/g, ' ').replace(/\s+/g, ' ').trim());
                descriptionInput.value = human || safeBase;
            }

            // Setup compression for images (except animated GIF)
            if (file.type.startsWith('image/') && file.type !== 'image/gif') {
                compression.enabled = true;
                compression.original.size = file.size;
                compression.original.type = file.type;
                loadImageMeta(file).then(({ width, height }) => {
                    compression.original.width = width;
                    compression.original.height = height;
                    // Reset defaults
                    compression.percent = 100; // default to 100%
                    compression.quality = 0.8;
                    document.getElementById('compress-quality').value = 80;
                    document.getElementById('compress-quality-label').textContent = '80';
                    // Mark 100% preset active
                    document.querySelectorAll('#compress-controls .preset-btn').forEach(b => {
                        b.classList.toggle('preset-active', b.dataset.percent === '100');
                        b.classList.toggle('preset-inactive', b.dataset.percent !== '100');
                    });
                    document.getElementById('compress-controls').classList.remove('hidden');
                    document.getElementById('compress-note').textContent = 'Images are converted to JPEG. Transparent areas become white.';
                    updateCompressionLabels();
                    computeCompressedBlob(); // initial compute
                }).catch(() => {
                    compression.enabled = false;
                    document.getElementById('compress-controls').classList.add('hidden');
                });
            } else if (file.type === 'image/gif') {
                document.getElementById('compress-note').textContent = 'Animated GIFs are uploaded without compression.';
                document.getElementById('compress-controls').classList.add('hidden');
            } else {
                // PDFs or others
                document.getElementById('compress-controls').classList.add('hidden');
            }

            updateUploadButtonState();
        }

        function loadImageMeta(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    resolve({ width: img.naturalWidth, height: img.naturalHeight });
                };
                img.onerror = reject;
                const reader = new FileReader();
                reader.onload = e => { img.src = e.target.result; };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function updateCompressionLabels() {
            const w = Math.max(1, Math.round(compression.original.width * (compression.percent / 100)));
            const h = Math.max(1, Math.round(compression.original.height * (compression.percent / 100)));
            document.getElementById('compress-res-label').textContent = `${compression.original.width}×${compression.original.height} → ${w}×${h}`;
            const sizeLbl = document.getElementById('compress-size-label');
            sizeLbl.textContent = `Original ${formatBytes(compression.original.size)} • Estimating...`;
        }

        function computeCompressedBlob() {
            if (!compression.enabled || !currentChosenFile) return;
            const targetW = Math.max(1, Math.round(compression.original.width * (compression.percent / 100)));
            const targetH = Math.max(1, Math.round(compression.original.height * (compression.percent / 100)));

            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = targetW;
                    canvas.height = targetH;
                    const ctx = canvas.getContext('2d', { alpha: false });
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, targetW, targetH);
                    ctx.drawImage(img, 0, 0, targetW, targetH);
                    canvas.toBlob(blob => {
                        if (blob) {
                            compression.blob = blob;
                            compression.blobSize = blob.size;
                            compression.outputExt = '.jpg';
                            document.getElementById('compress-size-label').textContent =
                                `Original ${formatBytes(compression.original.size)} • Compressed ${formatBytes(compression.blobSize)}`;
                            // Show decision UI if compressed is not beneficial
                            updateCompressDecisionUI(compression.original.size, compression.blobSize, currentChosenFile, compression.blob);
                        }
                    }, 'image/jpeg', compression.quality);
                };
                img.onerror = () => {
                    compression.blob = null;
                    compression.blobSize = 0;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(currentChosenFile);
        }

        // Show UI when compressed size >= original size to let user choose
        function updateCompressDecisionUI(originalSize, compressedSize, originalFile, compressedBlob) {
            const el = document.getElementById('compress-decision');
            el.innerHTML = '';
            if (!originalFile || !compressedBlob) { el.classList.add('hidden'); return; }
            // If compression doesn't help, show options
            if (compressedSize >= originalSize) {
                el.classList.remove('hidden');
                el.innerHTML = `
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                        <div class="font-medium text-yellow-800">Compression not beneficial</div>
                        <div class="text-xs text-yellow-700 mt-1">Compressed file is ${formatBytes(compressedSize)}, original is ${formatBytes(originalSize)}.</div>
                        <div class="mt-2 flex items-center gap-2">
                            <button type="button" id="use-original-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white  font-medium px-3 py-1 rounded">Use original</button>
                            <button type="button" id="use-compressed-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium px-3 py-1 rounded">Use compressed anyway</button>
                            <a id="download-original-link" class="ml-auto text-xs text-blue-600 hover:underline" href="#">Download original</a>
                            <a id="download-compressed-link" class="ml-2 text-xs text-blue-600 hover:underline" href="#">Download compressed</a>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">Tip: choose "Use original" to avoid increasing storage; "Use compressed" converts to JPEG which may be preferred for consistency.</div>
                    </div>`;

                // Wire buttons
                document.getElementById('use-original-btn').onclick = () => {
                    // mark that upload should use original file
                    compression._userChoice = 'original';
                    document.getElementById('compress-note').textContent = 'Will upload original file.';
                };
                document.getElementById('use-compressed-btn').onclick = () => {
                    compression._userChoice = 'compressed';
                    document.getElementById('compress-note').textContent = 'Will upload compressed JPEG.';
                };

                // Create download links
                const origUrl = URL.createObjectURL(originalFile);
                const compUrl = URL.createObjectURL(compressedBlob);
                const dlOrig = document.getElementById('download-original-link');
                const dlComp = document.getElementById('download-compressed-link');
                dlOrig.href = origUrl; dlOrig.download = originalFile.name || 'original';
                dlComp.href = compUrl; dlComp.download = (originalFile.name ? originalFile.name.replace(/\.[^/.]+$/, '') : 'compressed') + '.jpg';

                // If user hasn't chosen explicitly, default to 'original' to be safe
                if (!compression._userChoice) compression._userChoice = 'original';
            } else {
                el.classList.add('hidden');
                compression._userChoice = 'compressed'; // compressed is smaller => use it
            }
        }

        async function handleReceiptUpload() {
            const fileInput = document.getElementById('receipt-file-input');
            const filenameInput = document.getElementById('receipt-filename-input');
            const descriptionInput = document.getElementById('receipt-description-input');
            const statusDiv = document.getElementById('upload-status');
            const uploadBtn = document.getElementById('receipt-upload-btn');
            const browseBtn = document.getElementById('receipt-browse-btn');

            statusDiv.textContent = '';

            const file = currentChosenFile || (fileInput.files && fileInput.files[0]);
            const filenameRaw = (filenameInput.value || '').trim();
            const description = (descriptionInput.value || '').trim();

            if (!file) { alert('Please choose a file to upload.'); return; }
            if (!filenameRaw) { alert('Please enter a file name (without extension).'); return; }
            if (!description) { alert('Please enter a description.'); return; }

            const safeName = filenameRaw.replace(/[^\w\-]+/g, '_');

            const formData = new FormData();

            // Pick the right blob/file for upload
            // Decide what to send based on compression state and user's choice
            let blobToSend = file;
            let finalName = safeName;
            if (compression.enabled && compression.blob) {
                // If compression produced larger file, default to original unless user chose otherwise
                const choice = compression._userChoice || (compression.blobSize >= compression.original.size ? 'original' : 'compressed');
                if (choice === 'compressed') {
                    const jpgName = `${safeName}.jpg`;
                    blobToSend = new File([compression.blob], jpgName, { type: 'image/jpeg' });
                } else {
                    // keep original file
                    blobToSend = file;
                }
            }

            formData.append('receipt', blobToSend);
            formData.append('filename', safeName);
            formData.append('description', description);

            uploadBtn.disabled = true;
            browseBtn.disabled = true;
            statusDiv.textContent = 'Uploading...';

            try {
                const response = await fetch('/api/upload_receipt', {
                    method: 'POST',
                    body: formData
                });
                const txt = await response.text(); // robust parsing
                let result = null;
                try { result = JSON.parse(txt); } catch (_) {}

                if (!response.ok) {
                    throw new Error((result && result.error) || txt || 'Upload failed');
                }

                tempReceipts.push({
                    url: result.url,
                    filename: result.filename,
                    description: result.description
                });
                renderTempReceipts();

                statusDiv.textContent = 'Upload successful!';
                resetReceiptInputs(); // ready for next upload
            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
            } finally {
                uploadBtn.disabled = false;
                browseBtn.disabled = false;
            }
        }

        function renderTempReceipts() {
            const listDiv = document.getElementById('receipts-list');
            listDiv.innerHTML = tempReceipts.map((receipt, index) => {
                const displayName = receipt.description || 'Receipt';
                const metaName = receipt.filename || (receipt.url ? stripQuery(receipt.url).split('/').pop() : '');
                const url = receipt.url || '';
                const urlForCheck = stripQuery(url);
                const isImage = urlForCheck && /\.(png|jpe?g|webp|gif)$/i.test(urlForCheck);
                const thumbInner = isImage
                    ? `<img src="${url}" alt="" class="w-12 h-12 object-cover rounded mr-3 cursor-zoom-in" onclick="openLightbox('${url}')">`
                    : `<div class="w-12 h-12 flex items-center justify-center bg-gray-200 text-gray-600 rounded mr-3"><i class="far fa-file"></i></div>`;
                return `
                <div class="flex items-center justify-between bg-gray-100 p-2 rounded">
                    <div class="flex items-center min-w-0">
                        ${thumbInner}
                        <div class="min-w-0">
                            <a href="${url}" target="_blank" class="text-blue-600 hover:underline break-words">${displayName}</a>
                            <div class="text-xs text-gray-500 truncate">${metaName}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button type="button" onclick="openReceiptEditModal(${index})" class="text-indigo-600 hover:text-indigo-900" title="Edit"><i class="fas fa-pen"></i></button>
                        <button type="button" onclick="removeTempReceipt(${index})" class="text-red-500 hover:text-red-700 font-bold px-2" title="Remove">&times;</button>
                    </div>
                </div>`;
            }).join('');
        }

        async function removeTempReceipt(index) {
            const receipt = tempReceipts[index];
            if (!receipt) return;

            try {
                const filename = receipt.filename || (receipt.url ? stripQuery(receipt.url).split('/').pop() : null);
                if (filename) {
                    await fetch('/api/delete_receipt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename })
                    });
                }
            } catch (_) {
                // non-fatal
            }

            tempReceipts.splice(index, 1);
            renderTempReceipts();
        }

        // Lightbox
        function openLightbox(url) {
            const lb = document.getElementById('image-lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = url;
            lb.classList.remove('hidden');
            lb.classList.add('flex');
            document.body.classList.add('modal-active');
        }
        function closeLightbox() {
            const lb = document.getElementById('image-lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = '';
            lb.classList.add('hidden');
            lb.classList.remove('flex');
            document.body.classList.remove('modal-active');
        }

        // Keep upload button state in sync with inputs
        ['receipt-filename-input','receipt-description-input'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', updateUploadButtonState);
        });

        // --- Edit Receipt Modal Logic ---
        let editState = {
            index: null,
            original: null,
            chosenFile: null,
            userWantsReplace: false, // NEW: only send file when user opts to replace
            compression: {
                enabled: false,
                original: { width: 0, height: 0, size: 0, type: '' },
                percent: 100,
                quality: 0.8,
                blob: null,
                blobSize: 0
            }
        };

        function resetEditState() {
            editState = {
                index: null,
                original: null,
                chosenFile: null,
                userWantsReplace: false, // NEW
                compression: {
                    enabled: false,
                    original: { width: 0, height: 0, size: 0, type: '' },
                    percent: 100,
                    quality: 0.8,
                    blob: null,
                    blobSize: 0
                }
            };
            document.getElementById('edit-receipt-file-input').value = '';
            document.getElementById('edit-receipt-selected-name').textContent = '';
            document.getElementById('edit-receipt-clear-btn').classList.add('hidden');
            document.getElementById('edit-compress-controls').classList.add('hidden');
            document.getElementById('edit-compress-note').textContent = '';
        }

        async function openReceiptEditModal(index) {
            const r = tempReceipts[index];
            if (!r) return;
            resetEditState();
            editState.index = index;
            editState.original = { ...r };

            // Prefill fields
            const oldFile = r.filename || (r.url ? stripQuery(r.url).split('/').pop() : '');
            const base = oldFile.replace(/\.[^/.]+$/, '');
            document.getElementById('edit-receipt-index').value = String(index);
            document.getElementById('edit-receipt-filename-input').value = base;
            document.getElementById('edit-receipt-description-input').value = r.description || '';

            // Try to fetch existing file for compression if it's an image (not gif)
            try {
                const isImg = /\.(png|jpe?g|webp)$/i.test(oldFile);
                if (isImg && r.url) {
                    const resp = await fetch(r.url, { cache: 'no-store' });
                    const blob = await resp.blob();
                    const file = new File([blob], oldFile, { type: blob.type || 'image/jpeg' });
                    // Note: auto-loaded file does NOT imply user wants to replace
                    prepareEditCompression(file, false); // CHANGED
                    document.getElementById('edit-receipt-selected-name').textContent = oldFile + ' (current)';
                    document.getElementById('edit-receipt-clear-btn').classList.remove('hidden');
                }
            } catch (_) {
                // Non-fatal: user can still pick a replacement file
            }

            document.getElementById('receiptEditModal').classList.remove('hidden');
            document.body.classList.add('modal-active');
        }

        function closeReceiptEditModal() {
            document.getElementById('receiptEditModal').classList.add('hidden');
            document.body.classList.remove('modal-active');
            resetEditState();
        }

        function setupEditCompressionControls() {
            const presetBtns = Array.from(document.querySelectorAll('#edit-compress-controls .preset-btn'));
            const qInput = document.getElementById('edit-compress-quality');

            presetBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    presetBtns.forEach(b => { b.classList.remove('preset-active'); b.classList.add('preset-inactive'); });
                    btn.classList.add('preset-active'); btn.classList.remove('preset-inactive');
                    editState.compression.percent = parseInt(btn.dataset.percent || '100', 10);
                    updateEditCompressionLabels();
                    if (editState.compression.enabled) computeEditCompressedBlob();
                    editState.userWantsReplace = true; // NEW: user action implies replace
                });
            });

            qInput.addEventListener('input', () => {
                const q = Math.max(40, Math.min(100, parseInt(qInput.value, 10) || 80));
                editState.compression.quality = q / 100;
                document.getElementById('edit-compress-quality-label').textContent = String(q);
                if (editState.compression.enabled) computeEditCompressedBlob();
                editState.userWantsReplace = true; // NEW
            });

            // default 100%
            const def = document.querySelector('#edit-compress-controls .preset-btn[data-percent="100"]');
            if (def) { def.classList.add('preset-active'); def.classList.remove('preset-inactive'); }
        }

        // Accept a flag to indicate whether the file selection was user-initiated
        function prepareEditCompression(file, userInitiated = false) {
            editState.chosenFile = file;
            if (userInitiated) editState.userWantsReplace = true; // NEW
            const isGif = file.type === 'image/gif';
            if (file.type.startsWith('image/') && !isGif) {
                editState.compression.enabled = true;
                editState.compression.original.size = file.size;
                editState.compression.original.type = file.type;
                loadImageMeta(file).then(({ width, height }) => {
                    editState.compression.original.width = width;
                    editState.compression.original.height = height;
                    editState.compression.percent = 100;
                    editState.compression.quality = 0.8;
                    document.getElementById('edit-compress-quality').value = 80;
                    document.getElementById('edit-compress-quality-label').textContent = '80';
                    document.querySelectorAll('#edit-compress-controls .preset-btn').forEach(b => {
                        b.classList.toggle('preset-active', b.dataset.percent === '100');
                        b.classList.toggle('preset-inactive', b.dataset.percent !== '100');
                    });
                    document.getElementById('edit-compress-controls').classList.remove('hidden');
                    document.getElementById('edit-compress-note').textContent = 'Images are converted to JPEG. Transparent areas become white.';
                    updateEditCompressionLabels();
                    computeEditCompressedBlob();
                }).catch(() => {
                    editState.compression.enabled = false;
                    document.getElementById('edit-compress-controls').classList.add('hidden');
                });
            } else {
                document.getElementById('edit-compress-controls').classList.add('hidden');
                document.getElementById('edit-compress-note').textContent = isGif ? 'Animated GIFs are kept as-is (no compression).' : '';
                editState.compression.enabled = false;
                editState.compression.blob = null;
                editState.compression.blobSize = 0;
            }
        }

        function updateEditCompressionLabels() {
            const o = editState.compression.original;
            const w = Math.max(1, Math.round(o.width * (editState.compression.percent / 100)));
            const h = Math.max(1, Math.round(o.height * (editState.compression.percent / 100)));
            document.getElementById('edit-compress-res-label').textContent = `${o.width}×${o.height} → ${w}×${h}`;
            document.getElementById('edit-compress-size-label').textContent = `Original ${formatBytes(o.size)} • Estimating...`;
        }

        function computeEditCompressedBlob() {
            if (!editState.compression.enabled || !editState.chosenFile) return;
            const o = editState.compression.original;
            const targetW = Math.max(1, Math.round(o.width * (editState.compression.percent / 100)));
            const targetH = Math.max(1, Math.round(o.height * (editState.compression.percent / 100)));

            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = targetW; canvas.height = targetH;
                    const ctx = canvas.getContext('2d', { alpha: false });
                    ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, targetW, targetH);
                    ctx.drawImage(img, 0, 0, targetW, targetH);
                    canvas.toBlob(blob => {
                        if (blob) {
                            editState.compression.blob = blob;
                            editState.compression.blobSize = blob.size;
                            document.getElementById('edit-compress-size-label').textContent =
                                `Original ${formatBytes(o.size)} • Compressed ${formatBytes(blob.size)}`;
                            updateEditCompressDecisionUI(o.size, editState.compression.blobSize, editState.chosenFile, editState.compression.blob);
                        }
                    }, 'image/jpeg', editState.compression.quality);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(editState.chosenFile);
        }

        function updateEditCompressDecisionUI(originalSize, compressedSize, originalFile, compressedBlob) {
            const container = document.getElementById('edit-compress-controls');
            // We'll place a small decision area inside the edit controls
            let dec = document.getElementById('edit-compress-decision');
            if (!dec) {
                dec = document.createElement('div');
                dec.id = 'edit-compress-decision';
                dec.className = 'mt-2 text-sm';
                container.appendChild(dec);
            }
            dec.innerHTML = '';
            if (!originalFile || !compressedBlob) { dec.style.display = 'none'; return; }
            if (compressedSize >= originalSize) {
                dec.style.display = '';
                dec.innerHTML = `
                    <div class="p-2 bg-yellow-50 border border-yellow-200 rounded">
                        <div class="font-medium text-yellow-800">Compression not beneficial</div>
                        <div class="text-xs text-yellow-700">Compressed ${formatBytes(compressedSize)} • Original ${formatBytes(originalSize)}</div>
                                <div class="mt-2 flex items-center gap-2">
                                    <button type="button" id="edit-use-original-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium px-3 py-1 rounded">Use original</button>
                                    <button type="button" id="edit-use-compressed-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-3 py-1 rounded">Use compressed</button>
                                    <a id="edit-download-original-link" class="ml-auto text-xs text-blue-600 hover:underline" href="#">Download original</a>
                                    <a id="edit-download-compressed-link" class="ml-2 text-xs text-blue-600 hover:underline" href="#">Download compressed</a>
                                </div>
                    </div>`;

                document.getElementById('edit-use-original-btn').onclick = () => { editState.compression._userChoice = 'original'; document.getElementById('edit-compress-note').textContent = 'Will keep original file.'; };
                document.getElementById('edit-use-compressed-btn').onclick = () => { editState.compression._userChoice = 'compressed'; document.getElementById('edit-compress-note').textContent = 'Will use compressed JPEG.'; };

                const origUrl = URL.createObjectURL(originalFile);
                const compUrl = URL.createObjectURL(compressedBlob);
                const ldOrig = document.getElementById('edit-download-original-link');
                const ldComp = document.getElementById('edit-download-compressed-link');
                ldOrig.href = origUrl; ldOrig.download = originalFile.name || 'original';
                ldComp.href = compUrl; ldComp.download = (originalFile.name ? originalFile.name.replace(/\.[^/.]+$/, '') : 'compressed') + '.jpg';

                if (!editState.compression._userChoice) editState.compression._userChoice = 'original';
            } else {
                dec.style.display = 'none';
                editState.compression._userChoice = 'compressed';
            }
        }

        // File input for edit modal
        document.getElementById('edit-receipt-file-input').addEventListener('change', (e) => {
            const f = e.target.files && e.target.files[0] ? e.target.files[0] : null;
            const nameSpan = document.getElementById('edit-receipt-selected-name');
            if (!f) { nameSpan.textContent = ''; document.getElementById('edit-receipt-clear-btn').classList.add('hidden'); return; }
            if (!ALLOWED_RECEIPT_TYPES.includes(f.type)) {
                alert('Unsupported file type. Please select an image or PDF.');
                e.target.value = '';
                return;
            }
            if (f.size > MAX_RECEIPT_SIZE_BYTES) {
                alert('File too large. Max 10 MB.');
                e.target.value = '';
                return;
            }
            nameSpan.textContent = f.name;
            document.getElementById('edit-receipt-clear-btn').classList.remove('hidden');
            // Mark as user-initiated selection
            prepareEditCompression(f, true); // CHANGED
        });

        document.getElementById('edit-receipt-clear-btn').addEventListener('click', () => {
            document.getElementById('edit-receipt-file-input').value = '';
            document.getElementById('edit-receipt-selected-name').textContent = '';
            editState.userWantsReplace = false; // NEW: clear user intent
            // Restore to state of fetched original (if available) with compression
            if (editState.original) {
                const oldFile = editState.original.filename || (editState.original.url ? stripQuery(editState.original.url).split('/').pop() : '');
                const isImg = /\.(png|jpe?g|webp)$/i.test(oldFile);
                if (isImg && editState.original.url) {
                    // keep current compression state from fetched file; nothing to change
                } else {
                    // clear compression for non-images
                    editState.chosenFile = null;
                    editState.compression.enabled = false;
                    document.getElementById('edit-compress-controls').classList.add('hidden');
                    document.getElementById('edit-compress-note').textContent = '';
                }
            }
            document.getElementById('edit-receipt-clear-btn').classList.add('hidden');
        });

        // Save changes for edit modal
        document.getElementById('edit-receipt-form').addEventListener('submit', handleReceiptUpdate);

        async function handleReceiptUpdate(e) {
            e.preventDefault();
            const idx = parseInt(document.getElementById('edit-receipt-index').value, 10);
            const r = tempReceipts[idx];
            if (!r) return;

            const oldFilename = r.filename || (r.url ? stripQuery(r.url).split('/').pop() : '');
            const newBaseRaw = (document.getElementById('edit-receipt-filename-input').value || '').trim();
            const description = (document.getElementById('edit-receipt-description-input').value || '').trim();

            if (!newBaseRaw) { alert('Please enter a file name (without extension).'); return; }
            if (!description) { alert('Please enter a description.'); return; }

            const safeBase = newBaseRaw.replace(/[^\w\-]+/g, '_');

            const formData = new FormData();
            formData.append('old_filename', oldFilename);
            formData.append('new_base', safeBase);
            formData.append('description', description);

            // Decide which file to send (if any)
            let fileToSend = null;
            if (editState.userWantsReplace) {
                // If user provided a replacement or interacted with compression controls
                if (editState.compression.enabled && editState.compression.blob) {
                    const choice = editState.compression._userChoice || (editState.compression.blobSize >= editState.compression.original.size ? 'original' : 'compressed');
                    if (choice === 'compressed') {
                        const jpgName = `${safeBase}.jpg`;
                        fileToSend = new File([editState.compression.blob], jpgName, { type: 'image/jpeg' });
                    } else {
                        // If user wanted original, but we may have an auto-fetched file in chosenFile
                        if (editState.chosenFile) fileToSend = editState.chosenFile;
                    }
                } else if (document.getElementById('edit-receipt-file-input').files.length > 0) {
                    fileToSend = document.getElementById('edit-receipt-file-input').files[0];
                }
            } else {
                // Not replacing file; don't send receipt field
                fileToSend = null;
            }
            if (fileToSend) {
                // Guard against 10MB server limit to avoid HTML 413 responses
                if (fileToSend.size > MAX_RECEIPT_SIZE_BYTES) {
                    alert(`File too large (${formatBytes(fileToSend.size)}). Max allowed is 10 MB.`);
                    return;
                }
                formData.append('receipt', fileToSend);
            }

            try {
                const resp = await fetch('/api/update_receipt', { method: 'POST', body: formData });
                const text = await resp.text(); // robust parsing
                let result = null;
                try { result = JSON.parse(text); } catch (_) {}
                if (!resp.ok) {
                    throw new Error((result && result.error) || text || `HTTP ${resp.status}`);
                }

                // update local state + cache-bust url to avoid stale cache
                const vUrl = `${result.url}?v=${Date.now()}`;
                tempReceipts[idx] = {
                    url: vUrl,
                    filename: result.filename,
                    description: result.description
                };
                renderTempReceipts();
                closeReceiptEditModal();
            } catch (err) {
                alert(`Failed to update receipt: ${err.message}`);
            }
        }

        // Initialize edit compression controls
        setupEditCompressionControls();

        // Utility to strip query strings when checking extensions or deriving names
        function stripQuery(s) {
            return (s || '').split('?')[0];
        }

        // --- INITIAL DATA LOADING, RENDERING, CRUD, etc. ---
        // ...existing code...

        let pushing = false;

        async function pushToGitHub() {
            if (pushing) return;
            pushing = true;
            const btn = document.getElementById('push-btn');
            const label = document.getElementById('push-btn-label');
            const orig = label.textContent;
            btn.disabled = true;
            label.textContent = 'Pushing...';

            try {
                const resp = await fetch('/api/push', { method: 'POST' });
                const result = await resp.json().catch(() => ({}));
                if (!resp.ok) {
                    const msg = result && result.error ? result.error : `HTTP ${resp.status}`;
                    showPushResult(false, `Push failed: ${msg}`, '');
                    return;
                }

                const ok = !!result.success;
                const lines = [];
                (result.repos || []).forEach(r => {
                    const status = r.error ? 'FAILED' : (r.pushed ? 'pushed' : (r.committed ? 'committed' : 'up-to-date'));
                    lines.push(`• ${r.name}: ${status}${r.changed ? ' (changes detected)' : ''}`);
                });
                const summary = [
                    ok ? 'Push completed.' : 'Push completed with errors.',
                    result.started_at && result.finished_at ? `Time: ${result.started_at} → ${result.finished_at} (${result.duration_ms || 0} ms)` : ''
                ].concat(lines).join('\n').trim();

                const logs = (result.repos || []).map(r => {
                    const header = `===== ${r.name.toUpperCase()} =====`;
                    const body = (r.log || '').trim();
                    const err = r.error ? `\nERROR: ${r.error}` : '';
                    return `${header}\n${body}${err}`;
                }).join('\n\n');

                showPushResult(ok, summary, logs);
            } catch (e) {
                showPushResult(false, `Push failed: ${e.message}`, '');
            } finally {
                btn.disabled = false;
                label.textContent = orig;
                pushing = false;
            }
        }

        function showPushResult(success, summary, logs) {
            const modal = document.getElementById('pushModal');
            document.getElementById('push-summary').textContent = summary;
            document.getElementById('push-log').textContent = logs || '';
            modal.classList.remove('hidden');
            document.body.classList.add('modal-active');
        }

        function closePushModal() {
            const modal = document.getElementById('pushModal');
            modal.classList.add('hidden');
            document.body.classList.remove('modal-active');
        }
    </script>
</body>
</html>
